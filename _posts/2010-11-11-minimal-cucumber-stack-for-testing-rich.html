---
layout: post
title: Minimal cucumber stack for testing a rich javascript application
date: 2010-11-11
comments: false
---
<div class='post'>
These are instructions for setting up a very bare cucumber stack for testing a rich javascript application.<br /><br />All code available here: <a href="https://github.com/ngauthier/cucumber-webapp-demo">https://github.com/ngauthier/cucumber-webapp-demo</a><br /><br /><br />The following stack is used:<br /><br /><ul>  <li>Cucumber</li>  <li>Capybara</li>  <li>Selenium</li>  <li>WEBrick</li></ul><br /><br />First, we make our awesome javascript powered webapp:<br /><br /><pre class="prettyprint">&lt;!DOCTYPE html&gt;<br />&lt;html&gt;<br />  &lt;head&gt;<br />    &lt;script type='text/javascript' src='jquery-1.4.3.min.js'&gt;&lt;/script&gt;<br />    &lt;script type='text/javascript'&gt;<br />      $(function() {<br />        $('#special-link').click(function(event) {<br />          $('#results').html("This is totally awesome");<br />          event.preventDefault();<br />        });<br />      });<br />    &lt;/script&gt;<br />  &lt;/head&gt;<br />  &lt;body&gt;<br />    &lt;h1&gt;My Webapp&lt;/h1&gt;<br />    &lt;p&gt;<br />    &lt;a href='#' id='special-link'&gt;Click on this link to make cool stuff happen&lt;/a&gt;<br />    &lt;/p&gt;<br />    &lt;div id="results"&gt;&lt;/div&gt;<br />  &lt;/body&gt;<br />&lt;/html&gt;<br /><br /></pre><br />All we're doing here is showing some text when we click a link. But we're using jquery's events to do it.<br /><br /><br />Now here is our feature file:<br /><br /><pre class="prettyprint">Feature: My Awesome Link<br />  Scenario: Clicking the awesome link shows awesome text<br />    Given I am on the home page<br />    Then  I should see "My Webapp"<br />    And   I should see "Click on this link to make cool stuff happen"<br />    And   I should not see "This is totally awesome"<br />    When  I click "Click on this link to make cool stuff happen"<br />    Then  I should see "This is totally awesome"<br /></pre><br /><br />And here are our simple step definitions:<br /><br /><pre class="prettyprint">Given /^I am on the home page$/ do<br />  visit 'index.html'<br />end<br /><br />Then /^I should see "([^"]*)"$/ do |content|<br />  within('body') do<br />    assert page.has_content?(content)<br />  end<br />end<br /><br />Then /^I should not see "([^"]*)"$/ do |content|<br />  within('body') do<br />    refute page.has_content?(content)<br />  end<br />end<br /><br />When /^I click "([^"]*)"$/ do |link_text|<br />  click_link_or_button(link_text)<br />end<br /></pre><br /><br />And here is the cucumber environment file where all the magic happens. See comments for description:<br /><br /><pre class="prettyprint">require 'rubygems'<br />require 'cucumber'<br />require 'capybara/cucumber'<br />require 'webrick'<br /><br /># setup capybara on selenium<br />Capybara.default_driver = :selenium<br /><br /># This maps to webrick below<br />Capybara.app_host = 'http://127.0.0.1:3000'<br />Capybara.default_selector = :css<br /><br /># Extend Cucumber's World with minitest assertions<br />World(MiniTest::Assertions)<br /><br /># Launch a webrick server in a thread<br />AfterConfiguration do<br />  server_thread = Thread.new do<br />    project_root = File.join(File.dirname(__FILE__), '..', '..')<br />    WEBrick::HTTPServer.new(<br />      :Port => 3000,<br />      # TODO use the real application directory<br />      # Using the prototype directory for now<br />      :DocumentRoot => File.join(project_root, 'public'),<br />      :Logger => WEBrick::Log.new(File.join(project_root, 'cucumber.log')),<br />      :AccessLog => StringIO.new # to nowhere<br />    ).start<br />  end<br />  # Kill the server when cucumber is done<br />  at_exit do<br />    server_thread.exit<br />  end<br />end<br /></pre><br />The idea here is to boot webrick in a thread to serve the public directory, then connect selenium up to it. Very simple and light.<br /><br />All code available here: <a href="https://github.com/ngauthier/cucumber-webapp-demo">https://github.com/ngauthier/cucumber-webapp-demo</a></div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Sharad Jain</div>
<div class='content'>
Nice, thanks!</div>
</div>
</div>
